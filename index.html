<script>
    const GS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtNoerhDtHch7TNHVbItg23RG4nneoZ8hv5MBR1Cr40iU5alO8a2O4EUR90YgleMH4-E-6zGJsEgcN/pub?output=csv";
    const GID_ONGKIR = "780570550";
    const WA_ADMIN = "6281574938272";

    let allProduk = [], treeKategori = {}, cart = [], dataOngkir = [];
    let selectedBaseOngkir = 0, selectedWilayah = "";

    async function init() {
        try {
            const resP = await fetch(GS_URL + "&gid=0");
            const txtP = await resP.text();
            const rawP = parseCSV(txtP).slice(1);
            
            // Reset data agar tidak duplikat saat init ulang
            allProduk = [];
            treeKategori = {};

            allProduk = rawP.filter(col => col[0]).map((col, idx) => {
                const [ut, sub] = (col[2] || "Lainnya").includes(">") ? col[2].split(">").map(s => s.trim()) : [col[2].trim(), ""];
                if(!treeKategori[ut]) treeKategori[ut] = new Set();
                if(sub) treeKategori[ut].add(sub);
                return { 
                    id: idx, 
                    nama: col[0], 
                    harga: parseInt(col[1].replace(/[^\d]/g, "")) || 0, 
                    utama: ut, 
                    sub: sub, 
                    foto: col[3], 
                    desc: col[4],
                    berat: parseInt(col[5]) || 1000 
                };
            });

            const resO = await fetch(GS_URL + `&gid=${GID_ONGKIR}`);
            const rawO = parseCSV(await resO.text()).slice(1);
            dataOngkir = rawO.map(col => ({ wilayah: col[0], harga: parseInt(col[1].replace(/[^\d]/g, "")) || 0 }));

            renderNavs(); 
            renderProduk(allProduk);
        } catch(e) { 
            console.error("Gagal memuat data:", e); 
        }
    }

    // --- FUNGSI SEARCH PERBAIKAN TOTAL ---
    function search() {
        const searchInput = document.getElementById('main-search');
        const query = searchInput.value.toLowerCase().trim();
        const grid = document.getElementById('product-list');

        // Pindah ke tampilan katalog jika sedang di detail/checkout
        showView('catalog-view');

        if (query === "") {
            renderProduk(allProduk);
            return;
        }

        const filtered = allProduk.filter(p => 
            p.nama.toLowerCase().includes(query) || 
            p.utama.toLowerCase().includes(query) ||
            (p.sub && p.sub.toLowerCase().includes(query))
        );

        if (filtered.length > 0) {
            renderProduk(filtered);
        } else {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; background: white; border-radius: 12px;">
                    <p style="color: var(--gray); font-weight: 600;">Produk "${query}" tidak ditemukan.</p>
                    <button class="pro-back-btn" onclick="document.getElementById('main-search').value=''; renderProduk(allProduk);">Lihat Semua Produk</button>
                </div>`;
        }
    }

    // Listener untuk mendeteksi tombol Enter pada keyboard HP/PC
    document.getElementById('main-search').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            search();
            this.blur(); // Menyembunyikan keyboard di HP
        }
    });

    function parseCSV(text) { 
        return text.split("\n").map(row => 
            row.split(/,(?=(?:(?:[^\"*]*\"){2})*[^\"*]*$)/).map(c => 
                c.replace(/\"/g, "").trim()
            )
        ); 
    }

    function renderNavs() {
        const pc = document.getElementById('pc-list-inject'), m = document.getElementById('m-list-inject');
        pc.innerHTML = '<div style="font-weight:800; font-size:11px; color:#ccc; margin-bottom:15px;">MENU</div>';
        m.innerHTML = "";
        for(let ut in treeKategori) {
            let subs = Array.from(treeKategori[ut]);
            pc.innerHTML += `<div class="pc-cat-group">
                <div class="pc-cat-main" onclick="filterData('${ut}','all')">${ut}</div>
                <div class="pc-sub-dropdown">${subs.map(s => `<div class="sub-item-pc" onclick="filterData('${ut}','${s}')">${s}</div>`).join('')}</div>
            </div>`;
            m.innerHTML += `<div class="m-cat-item">
                <div class="m-cat-header" onclick="toggleMSub(this)"><span>${ut}</span><span>▾</span></div>
                <div class="m-sub-container">${subs.map(s => `<div class="m-sub-link" onclick="filterData('${ut}','${s}');toggleMMenu()">Semua ${s}</div>`).join('')}</div>
            </div>`;
        }
    }

    function renderProduk(list) {
        const grid = document.getElementById('product-list');
        if (!grid) return;
        grid.innerHTML = list.map(p => `
            <div class="product-card" onclick="openDetail(${p.id})">
                <img src="${p.foto}" class="thumb">
                <div class="p-info">
                    <div class="p-name">${p.nama}</div>
                    <div class="p-price">Rp ${p.harga.toLocaleString()}</div>
                </div>
            </div>`).join('');
    }

    function addToCart(id, direct) {
        const item = allProduk.find(x => x.id == id);
        const ada = cart.find(x => x.id == id);
        if(ada) ada.qty++; else cart.push({...item, qty: 1});
        updateBadge();
        if(direct) renderCheckout(); else showToast();
    }

    function updateQty(id, delta) {
        const item = cart.find(x => x.id == id);
        if(item) {
            item.qty += delta;
            if(item.qty <= 0) cart = cart.filter(x => x.id !== id);
        }
        updateBadge(); renderCheckout();
    }

    function updateWilayah(el) {
        const val = el.value;
        const found = dataOngkir.find(o => o.wilayah === val);
        selectedBaseOngkir = found ? found.harga : 0;
        selectedWilayah = val;
        renderCheckout(); 
    }

    function renderCheckout() {
        showView('checkout-view');
        const content = document.getElementById('checkout-content');
        if(cart.length === 0) {
            content.innerHTML = `<div style="text-align:center; padding:50px; background:white; border-radius:15px;"><p>Keranjang Kosong</p><button class="pro-back-btn" onclick="showView('catalog-view')">Belanja Sekarang</button></div>`;
            return;
        }

        const subtotal = cart.reduce((s, i) => s + (i.harga * i.qty), 0);
        const totalBeratGram = cart.reduce((s, i) => s + (i.berat * i.qty), 0);
        const totalBeratKg = Math.ceil(totalBeratGram / 1000);
        const totalOngkir = selectedBaseOngkir * totalBeratKg;
        const totalBayar = subtotal + totalOngkir;

        content.innerHTML = `
            <div class="checkout-layout">
                <div class="checkout-main">
                    <h3 style="margin-top:0">Item Belanja</h3>
                    ${cart.map(item => `
                        <div class="cart-item">
                            <img src="${item.foto}">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.nama}</div>
                                <div class="cart-item-price">Rp ${(item.harga * item.qty).toLocaleString()}</div>
                                <div style="font-size:11px; color:var(--gray)">Berat: ${(item.berat * item.qty / 1000).toFixed(1)}kg</div>
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
                                    <span style="font-weight:800">${item.qty}</span>
                                    <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
                                    <button class="delete-btn" onclick="updateQty(${item.id}, -${item.qty})">Hapus</button>
                                </div>
                            </div>
                        </div>`).join('')}
                    <div class="payment-info">
                        <p><strong>Informasi Pembayaran:</strong></p>
                        <p class="bank-name">BANK MANDIRI</p>
                        <p class="acc-number">1650000559519</p>
                        <p>A/N: <strong>ANDRI NURDIANSYAH</strong></p>
                    </div>
                </div>
                <div class="checkout-side">
                    <h3 style="margin-top:0">Data Pengiriman</h3>
                    <div class="form-group"><label>Nama</label><input type="text" id="cust-name" class="form-input"></div>
                    <div class="form-group"><label>WA</label><input type="tel" id="cust-wa" class="form-input"></div>
                    <div class="form-group">
                        <label>Wilayah</label>
                        <select class="form-input" onchange="updateWilayah(this)">
                            <option value="">-- Pilih --</option>
                            ${dataOngkir.map(o => `<option value="${o.wilayah}" ${selectedWilayah === o.wilayah ? 'selected' : ''}>${o.wilayah}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label>Alamat</label><textarea id="cust-addr" class="form-input"></textarea></div>
                    <div class="summary-box">
                        <div class="summary-row"><span>Subtotal</span><span>Rp ${subtotal.toLocaleString()}</span></div>
                        <div class="summary-row total-price"><span>Total</span><span>Rp ${totalBayar.toLocaleString()}</span></div>
                    </div>
                    <button class="btn-wa" onclick="sendWhatsApp()">Konfirmasi WA</button>
                </div>
            </div>`;
    }

    function sendWhatsApp() {
        const name = document.getElementById('cust-name').value;
        const wa = document.getElementById('cust-wa').value;
        const addr = document.getElementById('cust-addr').value;
        if(!name || !wa || !selectedWilayah || !addr) return alert('Lengkapi data!');

        const subtotal = cart.reduce((s, i) => s + (i.harga * i.qty), 0);
        const totalBeratKg = Math.ceil(cart.reduce((s, i) => s + (i.berat * i.qty), 0) / 1000);
        const total = subtotal + (selectedBaseOngkir * totalBeratKg);

        let msg = `*ORDER BARU*\nNama: ${name}\nWA: ${wa}\nAlamat: ${addr}\n\n*Pesanan:*\n`;
        cart.forEach(item => { msg += `- ${item.nama} (${item.qty}x)\n`; });
        msg += `\n*Total Transfer: Rp ${total.toLocaleString()}*`;
        
        window.open(`https://wa.me/${WA_ADMIN}?text=${encodeURIComponent(msg)}`);
    }

    function openDetail(id) {
        const p = allProduk.find(x => x.id == id);
        document.getElementById('detail-content').innerHTML = `
            <div class="pro-detail-wrapper">
                <div class="pro-detail-media"><img src="${p.foto}"></div>
                <div class="pro-detail-info">
                    <button class="pro-back-btn" onclick="showView('catalog-view')">← Kembali</button>
                    <h2 class="pro-title">${p.nama}</h2>
                    <div class="pro-price">Rp ${p.harga.toLocaleString()}</div>
                    <span class="pro-desc-label">Deskripsi</span>
                    <p class="pro-desc-content">${p.desc || '-'}</p>
                    <div class="pro-actions">
                        <button onclick="addToCart(${p.id}, false)" class="pro-btn pro-btn-cart">+ Keranjang</button>
                        <button onclick="addToCart(${p.id}, true)" class="pro-btn pro-btn-buy">Beli</button>
                    </div>
                </div>
            </div>`;
        showView('detail-view');
    }

    function toggleMSub(el) { el.nextElementSibling.classList.toggle('active'); }
    function toggleMMenu() { const o = document.getElementById('m-overlay'); o.style.display = o.style.display === 'block' ? 'none' : 'block'; }
    function showView(id) { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-v')); document.getElementById(id).classList.add('active-v'); window.scrollTo(0,0); }
    function filterData(ut, sub) { renderProduk(allProduk.filter(p => p.utama === ut && (sub === 'all' || p.sub === sub))); showView('catalog-view'); }
    function updateBadge() { document.getElementById('badge-count').innerText = cart.reduce((s, i) => s + i.qty, 0); }
    function showToast() { const t = document.getElementById("toast"); t.className = "show"; setTimeout(() => { t.className = ""; }, 2000); }

    init();
</script>
